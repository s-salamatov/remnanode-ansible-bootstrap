# Краткое руководство для контрибьюторов

## Принципы
- Изменения должны быть идемпотентными: повторный запуск плейбука не ломает состояние.
- Не добавляйте секреты в открытом виде. Все чувствительные данные — только в `group_vars/all/vault.yml` через `vault_common_*`.
- Поддерживайте структуру инвентаря (`inventory/README.md`) и документацию в актуальном состоянии.
- Локальные артефакты (`~/.ansible/common/...`) не должны попадать в репозиторий.

## Перед отправкой изменений
1. Обновите/расширьте документацию, если меняется структура, переменные или поведение ролей.
2. Проверьте синтаксис/лог, запустив:
   - `ansible-inventory --list -i inventory/hosts.yml`
   - При необходимости `ansible-playbook playbooks/shield-bootstrap.yml -l <host> --check`
3. Убедитесь, что новые переменные не содержат секретов по умолчанию — используйте placeholders и Vault.
4. Если добавляете новые роли/таски, придерживайтесь уже принятой структуры (`roles/common/...`) и используйте модули Ansible, а не shell, где это возможно.

## Работа с Vault
- Пароль лежит вне репозитория: `~/.ansible/common/.vault_password`.
- Редактирование: `ansible-vault edit group_vars/all/vault.yml`.
- Добавляйте секреты как `vault_<namespace>_<name>` и прокидывайте их через defaults/vars.

## SSH и локальные пути
- Роль сама управляет ключами и конфигом SSH. Не хардкодьте пути к ключам, используйте переменные `common_control_*`.
- При правке шаблонов, завязанных на env vars (Alloy), синхронизируйте значения между шаблоном и `env.conf.j2`.

## Стиль YAML/Ansible
- Отступы 2 пробела, без табов.
- Регистрируйте переменные через `register:` только при необходимости.
- Докладывайте важные изменения через `debug` минимально, без лишнего шума.

## Тестирование
- Минимум — `--check` на одном хосте/группе.
- Если трогаете SSH/сеть, внимательно проверяйте `handlers` и idempotency портов/hostnames в `~/.ssh/config`.
