# todo: Add option to configure SSH key types and lengths
# todo: Add integretions with ssh-agents
# todo: Add option to manage known_hosts entries
# todo: Add option to configure SSH login banners
# todo: Add check for SSH service availability after changes
# todo: Add option to configure SSH client settings on remote hosts
# todo: Implement SSH hardening best practices based on security benchmarks
# todo: Add option to enable fail2ban or similar intrusion prevention tools
# todo: Add support for SSH certificate authorities
# Harden sshd_config and verify before reloading service
- name: Backup old sshd_config
  ansible.builtin.copy:
    src: /etc/ssh/sshd_config
    dest: /etc/ssh/sshd_config.bak
    remote_src: true
    mode: "0600"

- name: Deploy hardened SSH config
  ansible.builtin.template:
    src: ssh/sshd_config.j2
    dest: /etc/ssh/sshd_config
    owner: root
    group: root
    mode: "0600"

- name: Test sshd config
  ansible.builtin.command: sshd -t
  register: common_ssh_config_test_result
  changed_when: false
  failed_when: common_ssh_config_test_result.rc != 0

- name: Reload SSH with verification (no handler)
  block:
    - name: Reload SSH daemon
      ansible.builtin.systemd:
        daemon_reload: true

    - name: Restart SSH
      ansible.builtin.systemd:
        name: ssh
        state: restarted

    - name: Update local SSH config port for host
      community.general.ssh_config:
        ssh_config_file: "{{ common_local_ssh_config }}"
        host: "{{ inventory_hostname }}"
        port: "{{ common_ssh_port | string }}"
      delegate_to: localhost
      become: false
      throttle: 1
      when: common_local_ssh_config is defined

  rescue:
    - name: Rollback SSH config after failed reload
      ansible.builtin.copy:
        src: /etc/ssh/sshd_config.bak
        dest: /etc/ssh/sshd_config
        remote_src: true
        mode: "0600"

    - name: Reload SSH daemon
      ansible.builtin.systemd:
        daemon_reload: true

    - name: Restart SSH
      ansible.builtin.systemd:
        name: ssh
        state: restarted